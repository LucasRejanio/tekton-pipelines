apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-image-tag
  namespace: tekton-pipelines
spec:
  params:
    - name: destination-branch
      description: Repository destination branch.
      type: string
    - name: merge-commit-hash
      type: string
  workspaces:
    - name: repository
    - name : ssh-directory
    - name: basic-auth
      optional: true
      description: |
        A Workspace containing a .gitconfig and .git-credentials file. These
        will be copied to the user's home before any git commands are run. Any
        other files in this Workspace are ignored. It is strongly recommended
        to use ssh-directory over basic-auth whenever possible and to bind a
        Secret to this Workspace over other volume types.

  steps:
    - image: alpine
      name: replace-tag-on-deployment
      env:
      - name: MERGE_COMMIT_HASH
        value: $(params.merge-commit-hash)
      script: |
        echo "----------- Instalando dependencias -----------"
        apk add bash sed

        #!/bin/bash
        source .env

        echo "----------- Atualizando tag da imagem -----------"
        sed -i "s|142401413602.dkr.ecr.sa-east-1.amazonaws.com/ecr-.*|142401413602.dkr.ecr.sa-east-1.amazonaws.com/ecr-$APPLICATION_NAME:$MERGE_COMMIT_HASH|" k8s/deployment.yaml

        if [ $? -eq 0 ]
        then
            echo "A tag imagem da aplicacao usada no deployment foi atualizada com sucesso"
            exit 0
        else
            echo "Falha ao atualizar tag da imagem da aplicação"
            exit 1
        fi
      securityContext:
        privileged: true
      workingDir: "$(workspaces.repository.path)"

    - image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.29.0
      name: push-modification-to-git
      env:
      - name: WORKSPACE_SSH_DIRECTORY_PATH
        value: $(workspaces.ssh-directory.path)
      - name: MERGE_COMMIT_HASH
        value: $(params.merge-commit-hash)
      - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
        value: $(workspaces.basic-auth.path)
      script: |
        echo "----------- Instalando dependencias -----------"
        apk add bash git openssh

        #!/bin/bash
        
        echo "----------- Configurando chave ssh -----------"
        cd /workspace/ssh-directory/
        mount -o remount,rw /
        chmod 400 id_rsa
        eval $(ssh-agent)
        ssh-add id_rsa
        
         if [ $? -eq 0 ]
        then
            echo "Chave ssh configurada com sucesso!"
        else
            echo "Falha ao configurar chave ssh"
            exit 1
        fi

        echo "----------- Subindo modificação para o repositório git -----------"
        cd ../repository
        git add . \
        && git commit -m "chore(deploy): updating image tag to '$MERGE_COMMIT_HASH'" \
        && git push origin main
      securityContext:
        privileged: true
